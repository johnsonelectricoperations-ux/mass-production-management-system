<!-- ì‘ì—…ì¼ì§€ ì‘ì„± í™”ë©´ (ì„¸ë¡œí˜•) -->
<div class="worklog-screen" id="worklogScreen">
    <div class="worklog-container-vertical">
        <div class="worklog-header">
            <div class="worklog-title">ğŸ“ ì‘ì—…ì¼ì§€ ì‘ì„±</div>
            <button class="worklog-close-btn" onclick="closeWorkLog()">ë‹«ê¸°</button>
        </div>

        <!-- ê³µí†µ ì •ë³´ ì˜ì—­ -->
        <div class="worklog-common-info">
            <div class="info-row">
                <label for="worklogDate">ì‘ì—…ì¼ì</label>
                <input type="date" id="worklogDate">
            </div>

            <div class="info-row">
                <label for="shiftSelect">ê·¼ë¬´ì¡°</label>
                <select id="shiftSelect" onchange="onShiftChange()">
                    <option value="A">Aì¡° (08:00~16:00)</option>
                    <option value="B">Bì¡° (16:00~24:00)</option>
                    <option value="C">Cì¡° (00:00~08:00)</option>
                </select>
            </div>

            <div class="info-row">
                <label for="commonWorker">ì‘ì—…ì</label>
                <input type="text" id="commonWorker" placeholder="ì¡° ì „ì²´ ì‘ì—…ì ì´ë¦„">
            </div>
        </div>

        <!-- ì‹œê°„ëŒ€ë³„ ì…ë ¥ ì¹´ë“œ -->
        <div class="hour-card" id="hourCard">
            <div class="hour-display">
                <button class="hour-nav-btn" onclick="prevHour()">â—€</button>
                <div class="current-hour" id="currentHour">08:00</div>
                <button class="hour-nav-btn" onclick="nextHour()">â–¶</button>
            </div>

            <div class="input-section">
                <div class="input-group">
                    <label>TM-No</label>
                    <input type="text" id="inputTmNo" placeholder="ì œí’ˆ ì½”ë“œ">
                </div>

                <div class="input-group">
                    <label>í’ˆëª…</label>
                    <input type="text" id="inputProduct" placeholder="ì œí’ˆ ì´ë¦„">
                </div>

                <div class="input-group">
                    <label>ì‹¤ì  (ìˆ˜ëŸ‰)</label>
                    <input type="number" id="inputQty" placeholder="0" min="0">
                </div>

                <div class="input-group">
                    <label>ë¹„ê°€ë™ì½”ë“œ</label>
                    <select id="inputDowncode">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                        <option value="D01">D01 - ì„¤ë¹„ê³ ì¥</option>
                        <option value="D02">D02 - ìì¬ë¶€ì¡±</option>
                        <option value="D03">D03 - ê¸ˆí˜•êµì²´</option>
                        <option value="D04">D04 - í’ˆì§ˆê²€ì‚¬</option>
                        <option value="D05">D05 - ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="input-group-row">
                    <div class="input-group">
                        <label>ë¹„ê°€ë™ ì‹œì‘</label>
                        <input type="time" id="inputDownstart">
                    </div>
                    <div class="input-group">
                        <label>ë¹„ê°€ë™ ì¢…ë£Œ</label>
                        <input type="time" id="inputDownend">
                    </div>
                </div>

                <div class="input-group">
                    <label>ë¹„ê°€ë™ ë‚´ì—­</label>
                    <textarea id="inputDowndetail" placeholder="ë¹„ê°€ë™ ë°œìƒ ì‚¬ìœ  ë° ì¡°ì¹˜ ë‚´ìš©"></textarea>
                </div>

                <div class="input-group-checkbox">
                    <label>
                        <input type="checkbox" id="inputBreakwork">
                        <span>íœ´ì‹ì‹œê°„ ê·¼ë¬´</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="worklog-buttons-vertical">
            <button class="btn btn-secondary" onclick="closeWorkLog()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveWorkLog()">ì „ì²´ ì €ì¥</button>
        </div>
    </div>
</div>

<style>
    /* ì„¸ë¡œí˜• ì‘ì—…ì¼ì§€ í™”ë©´ */
    .worklog-screen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .worklog-container-vertical {
        background: white;
        min-height: 100vh;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .worklog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
    }

    .worklog-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
    }

    .worklog-close-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        min-width: 80px;
    }

    .worklog-close-btn:active {
        background: #5a6268;
    }

    /* ê³µí†µ ì •ë³´ ì˜ì—­ */
    .worklog-common-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .info-row {
        margin-bottom: 15px;
    }

    .info-row:last-child {
        margin-bottom: 0;
    }

    .info-row label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .info-row input,
    .info-row select {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1.1em;
        box-sizing: border-box;
    }

    .info-row input:focus,
    .info-row select:focus {
        outline: none;
        border-color: #667eea;
    }

    /* ì‹œê°„ëŒ€ ì¹´ë“œ */
    .hour-card {
        background: white;
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        flex: 1;
    }

    .hour-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }

    .current-hour {
        font-size: 2em;
        font-weight: bold;
        color: white;
        text-align: center;
        flex: 1;
    }

    .hour-nav-btn {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 1.5em;
        cursor: pointer;
        min-width: 60px;
    }

    .hour-nav-btn:active {
        background: rgba(255, 255, 255, 0.5);
    }

    /* ì…ë ¥ ì˜ì—­ */
    .input-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .input-group {
        display: flex;
        flex-direction: column;
    }

    .input-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 1.05em;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1.1em;
        box-sizing: border-box;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    .input-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .input-group-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .input-group-checkbox {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .input-group-checkbox label {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
    }

    .input-group-checkbox input[type="checkbox"] {
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    .input-group-checkbox span {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
    }

    /* í•˜ë‹¨ ë²„íŠ¼ */
    .worklog-buttons-vertical {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: auto;
        padding-top: 20px;
    }

    .btn {
        padding: 18px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:active {
        background: #5568d3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:active {
        background: #5a6268;
    }

    @media (max-width: 600px) {
        .worklog-container-vertical {
            padding: 15px;
        }

        .current-hour {
            font-size: 1.8em;
        }

        .hour-nav-btn {
            padding: 12px 15px;
            min-width: 50px;
        }
    }
</style>

<script>
    let currentHourIndex = 0;
    let hourRange = [];
    let hourDataCache = {}; // ì‹œê°„ëŒ€ë³„ ì…ë ¥ ë°ì´í„° ì €ì¥

    // ì‘ì—…ì¼ì§€ ì—´ê¸°
    function openWorkLog() {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        document.getElementById('worklogDate').value = dateStr;

        // ì‹œê°„ëŒ€ ì´ˆê¸°í™”
        initHourRange();
        currentHourIndex = 0;
        hourDataCache = {};

        // ì²« ì‹œê°„ëŒ€ í‘œì‹œ
        displayCurrentHour();

        document.getElementById('worklogScreen').style.display = 'block';
    }

    // ê·¼ë¬´ì¡°ë³„ ì‹œê°„ ë²”ìœ„ ì´ˆê¸°í™”
    function initHourRange() {
        const selectedShift = document.getElementById('shiftSelect').value;

        if (selectedShift === 'A') {
            hourRange = [8, 9, 10, 11, 12, 13, 14, 15];
        } else if (selectedShift === 'B') {
            hourRange = [16, 17, 18, 19, 20, 21, 22, 23];
        } else { // Cì¡°
            hourRange = [0, 1, 2, 3, 4, 5, 6, 7];
        }
    }

    // ê·¼ë¬´ì¡° ë³€ê²½ ì‹œ
    function onShiftChange() {
        initHourRange();
        currentHourIndex = 0;
        hourDataCache = {};
        displayCurrentHour();
    }

    // í˜„ì¬ ì‹œê°„ëŒ€ í‘œì‹œ
    function displayCurrentHour() {
        const hour = hourRange[currentHourIndex];
        const hourStr = hour.toString().padStart(2, '0') + ':00';
        document.getElementById('currentHour').textContent = hourStr;

        // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
        if (hourDataCache[hour]) {
            const data = hourDataCache[hour];
            document.getElementById('inputTmNo').value = data.tmNo || '';
            document.getElementById('inputProduct').value = data.product || '';
            document.getElementById('inputQty').value = data.qty || '';
            document.getElementById('inputDowncode').value = data.downtimeCode || '';
            document.getElementById('inputDownstart').value = data.downtimeStart || '';
            document.getElementById('inputDownend').value = data.downtimeEnd || '';
            document.getElementById('inputDowndetail').value = data.downtimeDetail || '';
            document.getElementById('inputBreakwork').checked = data.breakWork || false;
        } else {
            // ë°ì´í„° ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            clearInputs();
        }
    }

    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    function clearInputs() {
        document.getElementById('inputTmNo').value = '';
        document.getElementById('inputProduct').value = '';
        document.getElementById('inputQty').value = '';
        document.getElementById('inputDowncode').value = '';
        document.getElementById('inputDownstart').value = '';
        document.getElementById('inputDownend').value = '';
        document.getElementById('inputDowndetail').value = '';
        document.getElementById('inputBreakwork').checked = false;
    }

    // í˜„ì¬ ì…ë ¥ ë°ì´í„° ì €ì¥
    function saveCurrentHourData() {
        const hour = hourRange[currentHourIndex];
        hourDataCache[hour] = {
            tmNo: document.getElementById('inputTmNo').value,
            product: document.getElementById('inputProduct').value,
            qty: document.getElementById('inputQty').value,
            downtimeCode: document.getElementById('inputDowncode').value,
            downtimeStart: document.getElementById('inputDownstart').value,
            downtimeEnd: document.getElementById('inputDownend').value,
            downtimeDetail: document.getElementById('inputDowndetail').value,
            breakWork: document.getElementById('inputBreakwork').checked
        };
    }

    // ì´ì „ ì‹œê°„
    function prevHour() {
        saveCurrentHourData();
        if (currentHourIndex > 0) {
            currentHourIndex--;
            displayCurrentHour();
        }
    }

    // ë‹¤ìŒ ì‹œê°„
    function nextHour() {
        saveCurrentHourData();
        if (currentHourIndex < hourRange.length - 1) {
            currentHourIndex++;
            displayCurrentHour();
        }
    }

    // ì‘ì—…ì¼ì§€ ë‹«ê¸°
    function closeWorkLog() {
        document.getElementById('worklogScreen').style.display = 'none';
    }

    // ì‘ì—…ì¼ì§€ ì €ì¥
    function saveWorkLog() {
        // í˜„ì¬ ì‹œê°„ëŒ€ ë°ì´í„°ë„ ì €ì¥
        saveCurrentHourData();

        const workDate = document.getElementById('worklogDate').value;
        const selectedShift = document.getElementById('shiftSelect').value;
        const commonWorker = document.getElementById('commonWorker').value;

        if (!commonWorker) {
            alert('ì‘ì—…ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const workLogData = [];

        // ëª¨ë“  ì‹œê°„ëŒ€ ë°ì´í„° ìˆ˜ì§‘
        hourRange.forEach(hour => {
            if (hourDataCache[hour]) {
                const data = hourDataCache[hour];
                // ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì €ì¥
                if (data.tmNo || data.product || data.qty) {
                    workLogData.push({
                        hour: hour,
                        worker: commonWorker,
                        tmNo: data.tmNo,
                        product: data.product,
                        qty: data.qty,
                        downtimeCode: data.downtimeCode,
                        downtimeStart: data.downtimeStart,
                        downtimeEnd: data.downtimeEnd,
                        downtimeDetail: data.downtimeDetail,
                        breakWork: data.breakWork
                    });
                }
            }
        });

        console.log('ì‘ì—…ì¼ì§€ ë°ì´í„°:', {
            date: workDate,
            shift: selectedShift,
            worker: commonWorker,
            process: selectedProcess,
            machine: selectedMachine,
            data: workLogData
        });

        // TODO: Google Apps Scriptë¡œ ë°ì´í„° ì „ì†¡
        // google.script.run
        //     .withSuccessHandler(function(response) {
        //         alert('ì‘ì—…ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        //         closeWorkLog();
        //     })
        //     .withFailureHandler(function(error) {
        //         alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        //     })
        //     .saveWorkLogData(workDate, selectedShift, commonWorker, selectedProcess, selectedMachine, workLogData);

        alert(`ì‘ì—…ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ ${workLogData.length}ê°œ ì‹œê°„ëŒ€ ë°ì´í„°\n(ê°œë°œ ì¤‘ - ì‹¤ì œ ì €ì¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„)`);
        closeWorkLog();
    }
</script>
