<!-- ì‘ì—…ì¼ì§€ ì‘ì„± í™”ë©´ (ì„¸ë¡œí˜• í…Œì´ë¸”) -->
<div class="worklog-screen" id="worklogScreen">
    <div class="worklog-container">
        <div class="worklog-header">
            <div class="worklog-title">ğŸ“ ì‘ì—…ì¼ì§€ ì‘ì„±</div>
            <button class="worklog-close-btn" onclick="closeWorkLog()">ë‹«ê¸°</button>
        </div>

        <!-- ì„ íƒëœ ê³µì •/ì„¤ë¹„ ì •ë³´ -->
        <div class="process-machine-info">
            <span class="info-label">ê³µì •:</span>
            <span class="info-value" id="displayProcessInfo">-</span>
            <span class="info-separator">/</span>
            <span class="info-label">ì„¤ë¹„:</span>
            <span class="info-value" id="displayMachineInfo">-</span>
        </div>

        <div class="worklog-date-selector">
            <div class="selector-group">
                <div class="selector-item">
                    <label for="worklogDate">ì‘ì—…ì¼ì</label>
                    <input type="date" id="worklogDate">
                </div>

                <div class="selector-item">
                    <label for="shiftSelect">ê·¼ë¬´ì¡°</label>
                    <select id="shiftSelect" onchange="onShiftChange()">
                        <option value="A">Aì¡° (08:00~16:00)</option>
                        <option value="B">Bì¡° (16:00~24:00)</option>
                        <option value="C">Cì¡° (00:00~08:00)</option>
                    </select>
                </div>

                <div class="selector-item">
                    <label for="workerName">ì‘ì—…ì</label>
                    <input type="text" id="workerName" placeholder="ì‘ì—…ì ì´ë¦„">
                </div>
            </div>
        </div>

        <div class="worklog-table-container">
            <table class="worklog-table" id="worklogTable">
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>TM-No</th>
                        <th>ë¹„ê°€ë™<br>ì½”ë“œ</th>
                        <th>ë¹„ê°€ë™<br>ì‹œì‘</th>
                        <th>ë¹„ê°€ë™<br>ì¢…ë£Œ</th>
                        <th>ë¹„ê°€ë™ë‚´ì—­</th>
                        <th>íœ´ì‹<br>ê·¼ë¬´</th>
                    </tr>
                </thead>
                <tbody id="worklogTableBody">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </tbody>
            </table>
        </div>

        <div class="worklog-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeWorkLog()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="saveWorkLog()">ì €ì¥</button>
        </div>
    </div>
</div>

<style>
    /* ì„¸ë¡œí˜• ì‘ì—…ì¼ì§€ í™”ë©´ */
    .worklog-screen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
        padding: 10px;
    }

    .worklog-container {
        background: white;
        border-radius: 15px;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        min-height: calc(100vh - 20px);
        display: flex;
        flex-direction: column;
    }

    .worklog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
    }

    .worklog-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
    }

    .worklog-close-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s;
    }

    .worklog-close-btn:active {
        background: #5a6268;
    }

    /* ê³µì •/ì„¤ë¹„ ì •ë³´ ì˜ì—­ */
    .process-machine-info {
        background: #f0f4ff;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        border: 2px solid #667eea;
    }

    .info-label {
        font-weight: 600;
        color: #495057;
        margin-right: 5px;
    }

    .info-value {
        font-weight: 700;
        color: #667eea;
        font-size: 1.1em;
    }

    .info-separator {
        margin: 0 15px;
        color: #dee2e6;
        font-weight: bold;
    }

    .worklog-date-selector {
        margin-bottom: 20px;
    }

    .selector-group {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
    }

    .selector-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .selector-item label {
        font-weight: 600;
        color: #333;
        font-size: 1em;
    }

    .selector-item input[type="date"],
    .selector-item input[type="text"],
    .selector-item select {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
    }

    @media (max-width: 600px) {
        .selector-group {
            grid-template-columns: 1fr;
        }
    }

    .worklog-table-container {
        overflow-x: auto;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        max-height: calc(100vh - 350px);
        flex: 1;
    }

    .worklog-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
    }

    .worklog-table th {
        background: #667eea;
        color: white;
        padding: 12px 6px;
        text-align: center;
        font-weight: 600;
        border: 1px solid #5568d3;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.95em;
        line-height: 1.3;
    }

    .worklog-table td {
        border: 1px solid #dee2e6;
        padding: 8px 4px;
        text-align: center;
    }

    .worklog-table td.time-cell {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        min-width: 60px;
        font-size: 1em;
    }

    .worklog-table td.shift-a {
        background: #fff3cd;
    }

    .worklog-table td.shift-b {
        background: #d1ecf1;
    }

    .worklog-table td.shift-c {
        background: #f8d7da;
    }

    .worklog-table input[type="text"],
    .worklog-table select,
    .worklog-table textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box;
    }

    .worklog-table textarea {
        min-height: 50px;
        resize: vertical;
    }

    .worklog-table input:focus,
    .worklog-table select:focus,
    .worklog-table textarea:focus {
        outline: none;
        border-color: #667eea;
        border-width: 2px;
    }

    .break-check {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .break-check input[type="checkbox"] {
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    .worklog-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
    }

    .btn {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:active {
        background: #5568d3;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:active {
        background: #5a6268;
    }

    @media (max-width: 600px) {
        .worklog-container {
            padding: 15px;
        }

        .worklog-table {
            font-size: 0.85em;
        }

        .worklog-table th {
            padding: 10px 4px;
            font-size: 0.85em;
        }

        .worklog-table input[type="text"],
        .worklog-table select,
        .worklog-table textarea {
            padding: 6px;
            font-size: 0.95em;
        }

        .selector-item input,
        .selector-item select {
            font-size: 0.95em;
        }
    }
</style>

<script>
    // ì‹œê°„ ì˜µì…˜ ìƒì„± (10ë¶„ ë‹¨ìœ„)
    function generateTimeOptions() {
        let options = '<option value="">ì„ íƒ</option>';
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 10) {
                const hourStr = h.toString().padStart(2, '0');
                const minStr = m.toString().padStart(2, '0');
                const timeValue = `${hourStr}:${minStr}`;
                options += `<option value="${timeValue}">${timeValue}</option>`;
            }
        }
        return options;
    }

    // ì‘ì—…ì¼ì§€ í…Œì´ë¸” ìƒì„±
    function generateWorkLogTable() {
        const tbody = document.getElementById('worklogTableBody');
        tbody.innerHTML = '';

        const selectedShift = document.getElementById('shiftSelect').value;

        // ê·¼ë¬´ì¡°ë³„ ì‹œê°„ ë²”ìœ„ ë° íœ´ì‹ì‹œê°„ ì„¤ì •
        let startHour, endHour, shiftClass, breakHours;

        if (selectedShift === 'A') {
            startHour = 8;
            endHour = 16;
            shiftClass = 'shift-a'; // Aì¡° (ë…¸ë€ìƒ‰)
            breakHours = [10, 12, 14]; // 10ì‹œ, 12ì‹œ, 14ì‹œ
        } else if (selectedShift === 'B') {
            startHour = 16;
            endHour = 24;
            shiftClass = 'shift-b'; // Bì¡° (íŒŒë€ìƒ‰)
            breakHours = [18, 20, 22]; // 18ì‹œ, 20ì‹œ, 22ì‹œ
        } else { // Cì¡°
            startHour = 0;
            endHour = 8;
            shiftClass = 'shift-c'; // Cì¡° (ë¹¨ê°„ìƒ‰)
            breakHours = [2, 4, 6]; // 02ì‹œ, 04ì‹œ, 06ì‹œ
        }

        // ì„ íƒëœ ê·¼ë¬´ì¡° ì‹œê°„ëŒ€ë§Œ í‘œì‹œ
        for (let hour = startHour; hour < endHour; hour++) {
            const hourStr = hour.toString().padStart(2, '0') + ':00';

            // íœ´ì‹ê·¼ë¬´ ì²´í¬ë°•ìŠ¤ í‘œì‹œ ì—¬ë¶€
            const hasBreakCheckbox = breakHours.includes(hour);
            const breakCell = hasBreakCheckbox
                ? `<div class="break-check"><input type="checkbox" id="breakwork_${hour}"></div>`
                : '-';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="time-cell">${hourStr}</td>
                <td class="${shiftClass}">
                    <input type="text" id="tmNo_${hour}" placeholder="TM-No" onchange="autoFillTmNo(${hour})">
                </td>
                <td class="${shiftClass}">
                    <select id="downcode_${hour}">
                        <option value="">-</option>
                        <option value="D01">D01</option>
                        <option value="D02">D02</option>
                        <option value="D03">D03</option>
                        <option value="D04">D04</option>
                        <option value="D05">D05</option>
                    </select>
                </td>
                <td class="${shiftClass}">
                    <select id="downstart_${hour}">
                        ${generateTimeOptions()}
                    </select>
                </td>
                <td class="${shiftClass}">
                    <select id="downend_${hour}">
                        ${generateTimeOptions()}
                    </select>
                </td>
                <td class="${shiftClass}">
                    <textarea id="downdetail_${hour}" placeholder="ë¹„ê°€ë™ë‚´ì—­"></textarea>
                </td>
                <td class="${shiftClass}">
                    ${breakCell}
                </td>
            `;
            tbody.appendChild(row);
        }
    }

    // TM-NO ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥
    function autoFillTmNo(changedHour) {
        const selectedShift = document.getElementById('shiftSelect').value;
        const tmNoValue = document.getElementById(`tmNo_${changedHour}`).value;

        // ê·¼ë¬´ì¡°ë³„ ì‹œê°„ ë²”ìœ„ ì„¤ì •
        let startHour, endHour;
        if (selectedShift === 'A') {
            startHour = 8;
            endHour = 16;
        } else if (selectedShift === 'B') {
            startHour = 16;
            endHour = 24;
        } else { // Cì¡°
            startHour = 0;
            endHour = 8;
        }

        // ë³€ê²½ëœ ì‹œê°„ ì´í›„ì˜ ëª¨ë“  ì‹œê°„ëŒ€ì— TM-NO ë³µì‚¬
        // ì´í›„ ì‹œê°„ëŒ€ ì¤‘ ë‹¤ë¥¸ TM-NOê°€ ë‚˜ì˜¤ê¸° ì „ê¹Œì§€ë§Œ ì±„ì›€
        for (let hour = changedHour + 1; hour < endHour; hour++) {
            const nextTmNo = document.getElementById(`tmNo_${hour}`);
            if (nextTmNo) {
                // ë‹¤ìŒ ì‹œê°„ëŒ€ê°€ ë¹„ì–´ìˆê±°ë‚˜ í˜„ì¬ ë³€ê²½ëœ ê°’ê³¼ ê°™ì€ ê²½ìš° ì—…ë°ì´íŠ¸
                if (!nextTmNo.value || nextTmNo.value === tmNoValue ||
                    nextTmNo.getAttribute('data-auto-filled') === 'true') {
                    nextTmNo.value = tmNoValue;
                    nextTmNo.setAttribute('data-auto-filled', 'true');
                } else {
                    // ë‹¤ë¥¸ ê°’ì´ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ëœ ê²½ìš° ì¤‘ë‹¨
                    break;
                }
            }
        }

        // í˜„ì¬ ì…ë ¥ì€ ìˆ˜ë™ ì…ë ¥ìœ¼ë¡œ í‘œì‹œ
        document.getElementById(`tmNo_${changedHour}`).setAttribute('data-auto-filled', 'false');
    }

    // ê·¼ë¬´ì¡° ë³€ê²½ ì‹œ í…Œì´ë¸” ì¬ìƒì„±
    function onShiftChange() {
        generateWorkLogTable();
    }

    // ì‘ì—…ì¼ì§€ ì—´ê¸°
    function openWorkLog() {
        // í˜„ì¬ ë‚ ì§œ ì„¤ì •
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        document.getElementById('worklogDate').value = dateStr;

        // ì„ íƒëœ ê³µì •/ì„¤ë¹„ ì •ë³´ í‘œì‹œ
        document.getElementById('displayProcessInfo').textContent = selectedProcess || '-';
        document.getElementById('displayMachineInfo').textContent = selectedMachine || '-';

        // í…Œì´ë¸” ìƒì„±
        generateWorkLogTable();

        // í™”ë©´ í‘œì‹œ
        document.getElementById('worklogScreen').style.display = 'block';
    }

    // ì‘ì—…ì¼ì§€ ë‹«ê¸°
    function closeWorkLog() {
        document.getElementById('worklogScreen').style.display = 'none';
    }

    // ì‘ì—…ì¼ì§€ ì €ì¥
    function saveWorkLog() {
        const workDate = document.getElementById('worklogDate').value;
        const selectedShift = document.getElementById('shiftSelect').value;
        const workerName = document.getElementById('workerName').value;

        if (!workerName) {
            alert('ì‘ì—…ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const workLogData = [];

        // ê·¼ë¬´ì¡°ë³„ ì‹œê°„ ë²”ìœ„ ì„¤ì •
        let startHour, endHour;
        if (selectedShift === 'A') {
            startHour = 8;
            endHour = 16;
        } else if (selectedShift === 'B') {
            startHour = 16;
            endHour = 24;
        } else { // Cì¡°
            startHour = 0;
            endHour = 8;
        }

        // ì„ íƒëœ ê·¼ë¬´ì¡° ì‹œê°„ëŒ€ë§Œ ë°ì´í„° ìˆ˜ì§‘
        for (let hour = startHour; hour < endHour; hour++) {
            const breakWorkCheckbox = document.getElementById(`breakwork_${hour}`);
            const rowData = {
                hour: hour,
                tmNo: document.getElementById(`tmNo_${hour}`).value,
                downtimeCode: document.getElementById(`downcode_${hour}`).value,
                downtimeStart: document.getElementById(`downstart_${hour}`).value,
                downtimeEnd: document.getElementById(`downend_${hour}`).value,
                downtimeDetail: document.getElementById(`downdetail_${hour}`).value,
                breakWork: breakWorkCheckbox ? breakWorkCheckbox.checked : false
            };

            // ë°ì´í„°ê°€ ìˆëŠ” í–‰ë§Œ ìˆ˜ì§‘
            if (rowData.tmNo || rowData.downtimeCode || rowData.downtimeDetail) {
                workLogData.push(rowData);
            }
        }

        console.log('ì‘ì—…ì¼ì§€ ë°ì´í„°:', {
            date: workDate,
            shift: selectedShift,
            worker: workerName,
            process: selectedProcess,
            machine: selectedMachine,
            data: workLogData
        });

        // TODO: Google Apps Scriptë¡œ ë°ì´í„° ì „ì†¡
        // google.script.run
        //     .withSuccessHandler(function(response) {
        //         alert('ì‘ì—…ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        //         closeWorkLog();
        //     })
        //     .withFailureHandler(function(error) {
        //         alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        //     })
        //     .saveWorkLogData(workDate, selectedShift, selectedProcess, selectedMachine, workLogData);

        alert(`ì‘ì—…ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ ${workLogData.length}ê°œ ì‹œê°„ëŒ€ ë°ì´í„°\n(ê°œë°œ ì¤‘ - ì‹¤ì œ ì €ì¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„)`);
        closeWorkLog();
    }
</script>
